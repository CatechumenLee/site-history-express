From a526e65b9a1383f4fcbaced63978300a87fe2ffe Mon Sep 17 00:00:00 2001
From: Site History User <user@example.com>
Date: Sat, 4 Oct 2025 11:13:38 +0800
Subject: [PATCH] =?UTF-8?q?feat:=20=E6=98=BE=E7=A4=BA=E5=85=A8=E5=B1=80?=
 =?UTF-8?q?=E5=8E=86=E5=8F=B2=E8=AE=B0=E5=BD=95=E8=80=8C=E9=9D=9E=E5=BD=93?=
 =?UTF-8?q?=E5=89=8D=E7=BD=91=E7=AB=99=E8=AE=B0=E5=BD=95?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

- ä¿®æ”¹åå°è„šæœ¬ï¼Œå§‹ç»ˆè¿”å›å…¨å±€å†å²è®°å½•è€Œä¸æ˜¯åŸºäºå½“å‰åŸŸåè¿‡æ»¤
- ç®€åŒ–å¼¹çª—ç•Œé¢ï¼Œç§»é™¤åŸŸååŒ¹é…æ¨¡å¼åˆ‡æ¢åŠŸèƒ½
- åˆ›å»ºæ–°çš„ createGlobalHistoryItems å‡½æ•°å¤„ç†å…¨å±€å†å²è®°å½•
- æ›´æ–° FilterBar ç»„ä»¶ï¼Œç§»é™¤åŒ¹é…æ¨¡å¼åˆ‡æ¢æŒ‰é’®
- æ·»åŠ  CLAUDE.md æ–‡ä»¶ï¼Œæä¾›é¡¹ç›®å¼€å‘æŒ‡å¯¼

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
---
 CLAUDE.md                               | 67 +++++++++++++++++++++++++
 src/background/index.ts                 | 27 ++++++++--
 src/popup/App.tsx                       | 16 ++----
 src/popup/component/FilterBar/index.tsx | 63 ++---------------------
 4 files changed, 97 insertions(+), 76 deletions(-)
 create mode 100644 CLAUDE.md

diff --git a/CLAUDE.md b/CLAUDE.md
new file mode 100644
index 0000000..777dc58
--- /dev/null
+++ b/CLAUDE.md
@@ -0,0 +1,67 @@
+# CLAUDE.md
+
+This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.
+
+## é¡¹ç›®æ¦‚è¿°
+
+Site History Express æ˜¯ä¸€ä¸ªæµè§ˆå™¨æ‰©å±•ç¨‹åºï¼Œç”¨äºæ˜¾ç¤ºå½“å‰ç½‘ç«™æˆ–æ‰€æœ‰ç½‘ç«™çš„æµè§ˆå†å²è®°å½•ã€‚è¯¥æ‰©å±•ä½¿ç”¨ React + TypeScript + Tailwind CSS å¼€å‘ï¼Œå¹¶é€šè¿‡ Rsbuild æ„å»ºã€‚
+
+## å¼€å‘å‘½ä»¤
+
+```bash
+# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
+yarn dev
+
+# æ„å»ºæ‰©å±•
+yarn build
+```
+
+## é¡¹ç›®æ¶æ„
+
+### æ„å»ºé…ç½®
+- ä½¿ç”¨ Rsbuild ä½œä¸ºæ„å»ºå·¥å…·ï¼Œé…ç½®æ–‡ä»¶ä¸º `rsbuild.config.ts`
+- æ”¯æŒä¸¤ä¸ªç¯å¢ƒï¼š
+  - `web`ï¼šæ„å»ºå¼¹çª—ç•Œé¢ (popup)
+  - `webworker`ï¼šæ„å»ºåå°è„šæœ¬ (background)
+
+### æ ¸å¿ƒæ¨¡å—
+
+#### åå°è„šæœ¬ (`src/background/index.ts`)
+- ç›‘å¬æµè§ˆå™¨å†å²è®°å½•å˜åŒ– (`chrome.history.onVisited`, `chrome.history.onVisitRemoved`)
+- ç»´æŠ¤å†…å­˜ä¸­çš„å†å²è®°å½•ç¼“å­˜ï¼Œä½¿ç”¨é˜²æŠ–ä¼˜åŒ–æ€§èƒ½
+- æä¾›ä¸¤ç§æ•°æ®è·å–æ–¹å¼ï¼š
+  - `getFlashItems()`ï¼šå¿«é€Ÿè·å–å°‘é‡é¡¹ç›®ç”¨äºå¼¹çª—æ˜¾ç¤º
+  - `getFullItems()`ï¼šè·å–å®Œæ•´çš„å†å²è®°å½•
+- å¤„ç†æ ‡ç­¾é¡µåˆ‡æ¢å’Œæ›´æ–°äº‹ä»¶
+
+#### å¼¹çª—ç•Œé¢ (`src/popup/`)
+- `App.tsx`ï¼šä¸»ç»„ä»¶ï¼Œè´Ÿè´£çŠ¶æ€ç®¡ç†å’Œæ•°æ®è·å–
+- `HistoryItemList`ï¼šå†å²è®°å½•åˆ—è¡¨ç»„ä»¶ï¼Œæ”¯æŒè™šæ‹Ÿæ»šåŠ¨
+- `FilterBar`ï¼šè¿‡æ»¤å’Œæœç´¢ç»„ä»¶
+
+#### å…¬å…±æ¨¡å— (`src/common/`)
+- `history.ts`ï¼šå†å²è®°å½•æ•°æ®ç»“æ„å’Œè·å–é€»è¾‘
+- `url.ts`ï¼šURL å¤„ç†å’ŒåŸŸåè§£æ
+- `mode.ts`ï¼šåŒ¹é…æ¨¡å¼ç®¡ç†ï¼ˆä¸¥æ ¼æ¨¡å¼/å®½æ¾æ¨¡å¼ï¼‰
+- `message.ts`ï¼šå‰åå°é€šä¿¡æ¥å£
+- `hash.ts`ï¼šå“ˆå¸Œè®¡ç®—å·¥å…·
+- `stream.ts`ï¼šé˜²æŠ–ç­‰æµå¤„ç†å·¥å…·
+
+### æ•°æ®æµ
+1. åå°è„šæœ¬ç›‘å¬å†å²è®°å½•å˜åŒ–ï¼Œæ›´æ–°å†…å­˜ç¼“å­˜
+2. å¼¹çª—æ‰“å¼€æ—¶ï¼Œå…ˆä» `chrome.storage.session` è·å–é¢„åŠ è½½çš„å°‘é‡æ•°æ®å¿«é€Ÿæ˜¾ç¤º
+3. ç„¶åé€šè¿‡æ¶ˆæ¯é€šä¿¡ä»åå°è„šæœ¬è·å–å®Œæ•´æ•°æ®
+4. æ”¯æŒåŸºäºå½“å‰ç½‘ç«™çš„åŸŸåè¿‡æ»¤å’Œå…³é”®è¯æœç´¢
+
+### æµè§ˆå™¨æ‰©å±•é…ç½®
+- `manifest.json`ï¼šæ‰©å±•é…ç½®æ–‡ä»¶ï¼Œå®šä¹‰æƒé™å’Œå…¥å£ç‚¹
+- æ”¯æŒå¤šè¯­è¨€ï¼šè‹±è¯­ã€ç®€ä½“ä¸­æ–‡ã€æ—¥è¯­
+- æƒé™ï¼š`tabs`, `history`, `storage`, `favicon`
+
+## å¼€å‘æ³¨æ„äº‹é¡¹
+
+- è¯¥é¡¹ç›®æ˜¯æµè§ˆå™¨æ‰©å±•ï¼Œéœ€è¦äº†è§£ Chrome Extension API
+- è™šæ‹Ÿæ»šåŠ¨ä½¿ç”¨ `react-virtualized` åº“å¤„ç†å¤§é‡å†å²è®°å½•
+- å‰åå°é€šä¿¡é€šè¿‡ `chrome.runtime.sendMessage` è¿›è¡Œ
+- å†å²è®°å½•æ•°æ®ç»è¿‡å»é‡å¤„ç†ï¼Œä½¿ç”¨ URL å’Œæ ‡é¢˜çš„å“ˆå¸Œå€¼ä½œä¸ºå”¯ä¸€æ ‡è¯†
+- åŒ¹é…æ¨¡å¼ä¼šä¿å­˜åœ¨ `chrome.storage.sync` ä¸­ï¼Œæ”¯æŒè·¨è®¾å¤‡åŒæ­¥
\ No newline at end of file
diff --git a/src/background/index.ts b/src/background/index.ts
index 59becc8..d868126 100644
--- a/src/background/index.ts
+++ b/src/background/index.ts
@@ -36,8 +36,8 @@ chrome.tabs.onUpdated.addListener(prepareFlashItemsDebounced);
 prepareFlashItemsDebounced();
 
 async function prepareFlashItems() {
-  const [url, allItems] = await Promise.all([getCurrentUrl(), ensureItems()]);
-  const items = filterDomainItems(allItems, url, 50);
+  const allItems = await ensureItems();
+  const items = createGlobalHistoryItems(allItems, 50);
   await chrome.storage.session.set({ flashItems: items });
 }
 
@@ -49,8 +49,8 @@ async function getFlashItems(): Promise<DomainHistoryItems> {
 }
 
 async function getFullItems(): Promise<DomainHistoryItems> {
-  const [url, allItems] = await Promise.all([getCurrentUrl(), ensureItems()]);
-  return filterDomainItems(allItems, url);
+  const allItems = await ensureItems();
+  return createGlobalHistoryItems(allItems);
 }
 
 export async function getCurrentUrl(): Promise<string> {
@@ -104,6 +104,25 @@ function filterDomainItems(allItems: HistoryItem[], currentUrl: string, maxCount
   return items;
 }
 
+function createGlobalHistoryItems(allItems: HistoryItem[], maxCount?: number): DomainHistoryItems {
+  const items: DomainHistoryItems = createDomainHistoryItems();
+  const keySet = new Set<number>();
+  const urlSet = new Set<string>();
+
+  for (const item of allItems) {
+    if (maxCount && items.main.length >= maxCount) {
+      break;
+    }
+    if (keySet.has(item.key) || urlSet.has(item.url)) {
+      continue;
+    }
+    keySet.add(item.key);
+    urlSet.add(item.url);
+    items.main.push(item);
+  }
+  return items;
+}
+
 chrome.runtime.onMessage.addListener((message, sender, send) => {
   switch (message.key) {
     case MessageKey.GetFlashItems:
diff --git a/src/popup/App.tsx b/src/popup/App.tsx
index 0d2c5fa..3498fa8 100644
--- a/src/popup/App.tsx
+++ b/src/popup/App.tsx
@@ -1,6 +1,5 @@
 import { useEffect, useState, useMemo } from 'react';
 
-import { MatchMode, DEFAULT_MATCH_MODE, getMatchMode, updateMatchMode } from '@/common/mode';
 import { MessageKey, sendMessage } from '@/common/message';
 import { HistoryItem, DomainHistoryItems, createDomainHistoryItems } from '@/common/history';
 import HistoryItemList from '@/popup/component/HistoryItemList';
@@ -10,11 +9,10 @@ export default function App() {
   const [domainItems, setDomainItems] = useState<DomainHistoryItems>(createDomainHistoryItems());
   const [filterText, setFilterText] = useState('');
   const [highlightedUrlSet, setHighlightedUrlSet] = useState<Set<string>>(new Set());
-  const [matchMode, setMatchMode] = useState<MatchMode>(DEFAULT_MATCH_MODE);
 
   const allItems = useMemo<HistoryItem[]>(() => {
-    return matchMode === MatchMode.Strict && domainItems.domain.main ? domainItems.sub : domainItems.main;
-  }, [domainItems, matchMode]);
+    return domainItems.main;
+  }, [domainItems]);
 
   const filteredItems = useMemo<HistoryItem[]>(() => {
     const keywords = filterText.toLowerCase().trim().split(/\s+/).filter(Boolean);
@@ -42,27 +40,19 @@ export default function App() {
     const [flashDomainItems, tabUrls] = await Promise.all([getFlashItems(), getHighlightedUrlSet()]);
     setDomainItems(flashDomainItems);
     setHighlightedUrlSet(tabUrls);
-    setMatchMode(await getMatchMode(flashDomainItems.domain.main));
     setDomainItems(await getFullItems());
     setTimeout(() => {
       document.body.classList.add('ready');
     });
   }
 
-  async function toggleMatchMode() {
-    const newMode = matchMode === MatchMode.Strict ? MatchMode.Loose : MatchMode.Strict;
-    setMatchMode(newMode);
-    await updateMatchMode(domainItems.domain.main, newMode);
-  }
-
+  
   return (
     <div>
       <HistoryItemList items={filteredItems} total={allItems.length} highlightedUrlSet={highlightedUrlSet} />
       <FilterBar
         domain={domainItems.domain}
-        matchMode={matchMode}
         onTextChange={setFilterText}
-        onToggleMatchMode={toggleMatchMode}
       />
     </div>
   );
diff --git a/src/popup/component/FilterBar/index.tsx b/src/popup/component/FilterBar/index.tsx
index fe2c3ec..2db468c 100644
--- a/src/popup/component/FilterBar/index.tsx
+++ b/src/popup/component/FilterBar/index.tsx
@@ -1,28 +1,20 @@
 import { useState, useCallback, useMemo, useEffect, useRef } from 'react';
 
-import { MatchMode } from '@/common/mode';
 import { Domain } from '@/common/url';
 import { debounce } from '@/common/stream';
 import { i18n } from '@/common/i18n';
 
 export interface Props {
   domain: Domain;
-  matchMode: MatchMode;
+  matchMode?: any;
   onTextChange: (text: string) => void;
-  onToggleMatchMode: () => void;
+  onToggleMatchMode?: () => void;
 }
 
 export default function FilterBar({ domain, matchMode, onTextChange, onToggleMatchMode }: Props) {
-  const canToggleMatchMode = useMemo(() => !!domain.main, [domain]);
   const placeholder = useMemo(() => {
-    if (!domain.main) {
-      return i18n.filterGlobalPlaceholder;
-    }
-    if (matchMode === MatchMode.Strict) {
-      return i18n.filterPlaceholder(domain.sub ? `${domain.sub}.${domain.main}` : domain.main);
-    }
-    return i18n.filterPlaceholder(`*.${domain.main}`);
-  }, [domain, matchMode]);
+    return i18n.filterGlobalPlaceholder;
+  }, []);
 
   const [text, setText] = useState('');
   const debouncedUpdate = useCallback(debounce(onTextChange, 300), []);
@@ -41,11 +33,6 @@ export default function FilterBar({ domain, matchMode, onTextChange, onToggleMat
     inputRef.current?.focus();
   }, []);
 
-  function handleBtnClick() {
-    inputRef.current?.focus();
-    onToggleMatchMode();
-  }
-
   return (
     <div className='flex items-center h-[40px] border-t border-[--color-border] shadow-lg shadow-[--color-text]'>
       <input
@@ -60,49 +47,7 @@ export default function FilterBar({ domain, matchMode, onTextChange, onToggleMat
         onChange={handleTextChange}
         onClick={() => setShouldHideCaret(false)}
       />
-      {canToggleMatchMode && (
-        <button className='h-full p-3 outline-none opacity-30 hover:opacity-50' onClick={handleBtnClick}>
-          {matchMode === MatchMode.Strict ? <StrictModeSvg /> : <LooseModeSvg />}
-        </button>
-      )}
     </div>
   );
 }
 
-function StrictModeSvg() {
-  return (
-    <svg
-      style={{ width: '16px', height: '16px' }}
-      fill='none'
-      stroke='currentColor'
-      viewBox='0 0 24 24'
-      xmlns='http://www.w3.org/2000/svg'
-    >
-      <path
-        strokeLinecap='round'
-        strokeLinejoin='round'
-        strokeWidth='2'
-        d='M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4'
-      ></path>
-    </svg>
-  );
-}
-
-function LooseModeSvg() {
-  return (
-    <svg
-      style={{ width: '16px', height: '16px' }}
-      fill='none'
-      stroke='currentColor'
-      viewBox='0 0 24 24'
-      xmlns='http://www.w3.org/2000/svg'
-    >
-      <path
-        strokeLinecap='round'
-        strokeLinejoin='round'
-        strokeWidth='2'
-        d='M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5'
-      ></path>
-    </svg>
-  );
-}
-- 
2.51.0.windows.1

